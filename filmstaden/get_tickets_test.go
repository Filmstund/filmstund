package filmstaden_test

import (
	"context"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/filmstund/filmstund/filmstaden"
	"gotest.tools/v3/assert"
	"gotest.tools/v3/assert/cmp"
)

const ticketResponse = `[{"id":"TI-YK91VMOUNG","referenceNumber":"5BZZVDHC9SNS","profileId":"UH6ZJ9","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-YK91VMOUNG","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":30,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]},{"id":"TI-U7JMQFXUPY","referenceNumber":"5BZZVDHC9SNS","profileId":"9D2PB7","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-U7JMQFXUPY","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":31,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]},{"id":"TI-WM8KI0GY66","referenceNumber":"5BZZVDHC9SNS","profileId":"X82X52","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-WM8KI0GY66","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":32,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]},{"id":"TI-QHTVC6QER6","referenceNumber":"5BZZVDHC9SNS","profileId":"ES2SE5","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-QHTVC6QER6","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":33,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]},{"id":"TI-RFWT2R70C8","referenceNumber":"5BZZVDHC9SNS","profileId":"B46K25","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-RFWT2R70C8","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":34,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]},{"id":"TI-9UM3OZ2HQZ","referenceNumber":"5BZZVDHC9SNS","profileId":"6R5782","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-9UM3OZ2HQZ","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":35,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]},{"id":"TI-V9OWAQ0YY8","referenceNumber":"5BZZVDHC9SNS","profileId":"EY3GA6","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-V9OWAQ0YY8","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":36,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]},{"id":"TI-3BWR12TGMV","referenceNumber":"5BZZVDHC9SNS","profileId":"R25BJ7","customerTypeDefinition":"Adult","customerType":"Ordinarie","ageGroup":"11 år","qrCode":"TI-3BWR12TGMV","toiletCode":"","isRefunded":false,"cinema":{"title":"Biopalatset","company":{"name":"Filmstaden","images":[{"url":"https://catalog.cinema-api.com/cf/images/ncg-images/6eca2327fd0e4ccfbea7ad40c216ebcf.png?width=120&version=D2D58D1A0B908353F9948DB7CA43774E","type":"LogoOnWhiteBackground"}]},"city":{"name":null}},"movie":{"title":"Spider-Man: No Way Home","rating":{"displayName":"11 år"}},"show":{"remoteEntityId":"20211220-1810-1047","date":"2021-12-20","time":"18:10","showDateTimeUtc":"2021-12-20T17:10:00Z","unnumbered":false,"attributes":[{"displayName":"5.1"},{"displayName":"textad"},{"displayName":"en"}]},"seat":{"row":4,"number":37,"section":"Parkett","type":"REGULAR","unnumberedText":"Onumrerad föreställning"},"screen":{"title":"Salong 2"},"receipt":{"net":"127,20 kr","vat":"31,80 kr","total":"159,00 kr","transactionDate":"2021-12-19","transactionTime":"18:09","infoText":""},"labels":{"show":{"date":null,"time":"Tid"},"seat":{"row":"Rad","number":"Stolsnr","section":"Sektion"},"screen":{"title":"Salong"},"receipt":{"net":"Netto","vat":"Moms","total":"Totalt"}},"products":[]}]`

func TestClient_Tickets(t *testing.T) {
	srv := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		_, err := w.Write([]byte(ticketResponse))
		assert.NilError(t, err)
	}))
	defer srv.Close()
	client := filmstaden.NewClient(srv.URL)
	tickets, err := client.Tickets(context.TODO(), "Sys99-SE", "20211220-1810-1047", "5BZZVDHC9SNS")
	assert.NilError(t, err)
	assert.Check(t, cmp.Len(tickets, 8))
	assert.Equal(t, tickets[0].ID, "TI-YK91VMOUNG")
	assert.Equal(t, tickets[1].ID, "TI-U7JMQFXUPY")
	assert.Equal(t, tickets[2].ID, "TI-WM8KI0GY66")
	assert.Equal(t, tickets[3].ID, "TI-QHTVC6QER6")
	assert.Equal(t, tickets[4].ID, "TI-RFWT2R70C8")
	assert.Equal(t, tickets[5].ID, "TI-9UM3OZ2HQZ")
	assert.Equal(t, tickets[6].ID, "TI-V9OWAQ0YY8")
	assert.Equal(t, tickets[7].ID, "TI-3BWR12TGMV")
}

func TestClient_Tickets_BadResponse(t *testing.T) {
	srv := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusInternalServerError)
		_, err := w.Write([]byte(`{"error": "herpderp"}`))
		assert.NilError(t, err)
	}))
	defer srv.Close()
	client := filmstaden.NewClient(srv.URL)
	tickets, err := client.Tickets(context.Background(), "Sys99-SE", "20211220-1810-1047", "5BZZVDHC9SNS")
	assert.Check(t, cmp.Len(tickets, 0))
	assert.Check(t, cmp.Error(err, "error fetching Filmstaden tickets, got 500 Internal Server Error"))
}
